<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Growtopia - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body class="flex flex-col items-center justify-center h-screen bg-transparent">
    <div class="fixed inset-0 flex justify-center items-start pt-8">
        <div
            id="loginModal"
            class="relative bg-[#2b4d6d] border-4 border-[#87b8cc] shadow-lg p-8 w-3/5 max-w-lg sm:w-4/5 xs:w-11/12 h-60 rounded-lg flex flex-col justify-center opacity-0 translate-y-[-20px] transition-all duration-700 ease-out">
            <p class="text-white text-center font-bold text-2xl">Log in with your Grow ID</p>
            <div id="errorDiv"
                class="hidden flex flex-col mt-2 text-xs text-red-700 font-bold px-[5px] bg-[#2b4d6d] rounded">
                <a id="errorMessage"></a>
            </div>
            <form method="post" action="/player/growid/login/validate" accept-charset="UTF-8" id="loginForm"
                class="mt-3">
                <div class="mb-1">
                    <input name="type" value="log" type="hidden" />
                    <input name="_token" id="hiddenToken" value="{{ data }}" type="hidden" />
                    <input name="has_reg" value="0" type="hidden" />
                    <label for="loginGrowId" class="block text-white text-xs">GrowID</label>
                    <div class="flex items-center border-2 border-[#81d4fa] rounded bg-[#2b4d6d] px-1 py-1">
                        <i class="fas fa-user text-white mr-1 text-xs"></i>
                        <input type="text" name="growId" id="loginGrowId"
                            class="w-full bg-[#2b4d6d] text-white text-xs placeholder-white focus:outline-none"
                            placeholder="Enter your growid">
                    </div>
                </div>
                <div class="mb-1">
                    <label for="loginPassword" class="block text-white text-xs">Password</label>
                    <div class="flex items-center border-2 border-[#81d4fa] rounded bg-[#2b4d6d] px-1 py-1">
                        <i class="fas fa-lock text-white mr-1 text-xs"></i>
                        <input type="password" name="password" id="loginPassword"
                            class="w-full bg-[#2b4d6d] text-white text-xs placeholder-white focus:outline-none"
                            placeholder="Enter your password">
                        <button type="button" id="toggleLogPassword" class="text-white ml-2 focus:outline-none text-xs">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="mb-1">
                    <label for="loginServerName" class="block text-white text-xs">ServerName</label>
                    <div class="flex items-center border-2 border-[#81d4fa] rounded bg-[#2b4d6d] px-1 py-1">
                        <input type="text" name="ServerName" id="loginServerName"
                            class="w-full bg-[#2b4d6d] text-white text-xs placeholder-white focus:outline-none"
                            placeholder="ServerName (e.g. localhost)">
                    </div>
                </div>
                <div class="flex justify-end items-center">
                    <button id="loginButton"
                        class="px-2 py-1 rounded bg-[#00b8ff] text-white text-xs hover:bg-[#06a4dd] transition duration-300 ease-in-out transform hover:scale-105">Login</button>
                </div>
            </form>

            <div class="mt-3">
                <div class="flex justify-between items-center mb-2">
                    <div>
                        <button id="showLogin" class="px-2 py-1 mr-2 rounded bg-[#00b8ff] text-white text-xs">Login</button>
                        <button id="showRegister" class="px-2 py-1 rounded bg-[#06c57b] text-white text-xs">Register</button>
                    </div>
                </div>

                <!-- Register form (hidden by default) -->
                <form method="post" action="/player/growid/login/validate" accept-charset="UTF-8" id="registerForm" class="mt-3 hidden">
                    <input name="type" value="reg" type="hidden" />
                    <input name="_token" id="hiddenTokenReg" value="{{ data }}" type="hidden" />
                    <input name="has_reg" value="1" type="hidden" />
                    <div class="mb-1">
                        <label for="regGrowId" class="block text-white text-xs">GrowID</label>
                        <div class="flex items-center border-2 border-[#81d4fa] rounded bg-[#2b4d6d] px-1 py-1">
                            <i class="fas fa-user text-white mr-1 text-xs"></i>
                            <input type="text" name="growId" id="regGrowId"
                                class="w-full bg-[#2b4d6d] text-white text-xs placeholder-white focus:outline-none"
                                placeholder="Enter your growid">
                        </div>
                    </div>
                    <div class="mb-1">
                        <label for="regPassword" class="block text-white text-xs">Password</label>
                        <div class="flex items-center border-2 border-[#81d4fa] rounded bg-[#2b4d6d] px-1 py-1">
                            <i class="fas fa-lock text-white mr-1 text-xs"></i>
                            <input type="password" name="password" id="regPassword"
                                class="w-full bg-[#2b4d6d] text-white text-xs placeholder-white focus:outline-none"
                                placeholder="Enter your password">
                        </div>
                    </div>
                    <div class="mb-1">
                        <label for="regEmail" class="block text-white text-xs">Email</label>
                        <div class="flex items-center border-2 border-[#81d4fa] rounded bg-[#2b4d6d] px-1 py-1">
                            <i class="fas fa-envelope text-white mr-1 text-xs"></i>
                            <input type="email" name="email_reg" id="regEmail"
                                class="w-full bg-[#2b4d6d] text-white text-xs placeholder-white focus:outline-none"
                                placeholder="Enter your email">
                        </div>
                    </div>
                    <div class="mb-1">
                        <label for="regServer" class="block text-white text-xs">ServerName</label>
                        <div class="flex items-center border-2 border-[#81d4fa] rounded bg-[#2b4d6d] px-1 py-1">
                            <input type="text" name="ServerName" id="regServer"
                                class="w-full bg-[#2b4d6d] text-white text-xs placeholder-white focus:outline-none"
                                placeholder="ServerName (e.g. localhost)">
                        </div>
                    </div>
                    <div class="flex justify-end items-center">
                        <button id="registerButton" type="button"
                            class="px-2 py-1 rounded bg-[#06c57b] text-white text-xs hover:bg-[#05b76a] transition duration-300">Register</button>
                    </div>
                </form>

                <div class="mt-3 text-xs text-white">
                    <p class="font-bold">Example Encoded Tokens</p>
                    <div class="mt-1">
                        <div class="mb-1">Register (example): <code id="regEncoded" class="break-all"></code></div>
                        <div>Login (example): <code id="logEncoded" class="break-all"></code></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (localStorage.getItem('growId')) {
                document.getElementById('loginGrowId').value = localStorage.getItem('growId');
            }

            // Trigger modal animation
            setTimeout(function() {
                const modal = document.getElementById('loginModal');
                if (modal) {
                    modal.classList.remove('opacity-0', 'translate-y-[-20px]');
                }
            }, 100);

            const loginGrowId = document.getElementById('loginGrowId').value
            const loginPassword = document.getElementById('loginPassword').value

            // ensure hidden token is in expected simple format for server-side assembly
            const hiddenToken = document.getElementById('hiddenToken');
            if (hiddenToken) {
                hiddenToken.value = '{}';
            }

            // prepare example encoded tokens and display them
            const serverName = window.location.hostname || 'localhost';
            const regPlain = `_token={}&growId=dios&password=12341234&email_reg=dios@gmail.com&has_reg=1&ServerName=${serverName}`;
            const logPlain = `_token={}&growId=dios&password=12341234&email_reg=undefined&has_reg=0&ServerName=${serverName}`;
            function encodeUTF8ToBase64(str) {
                return btoa(unescape(encodeURIComponent(str)));
            }
            const regEncoded = encodeUTF8ToBase64(regPlain);
            const logEncoded = encodeUTF8ToBase64(logPlain);
            const regEl = document.getElementById('regEncoded');
            const logEl = document.getElementById('logEncoded');
            if (regEl) regEl.innerText = regEncoded;
            if (logEl) logEl.innerText = logEncoded;
        });
        document.getElementById('loginButton').addEventListener('click', function (event) {
            event.preventDefault();

            const loginForm = document.getElementById('loginForm');
            const uName = document.getElementById('loginGrowId').value;
            const uPass = document.getElementById('loginPassword').value;

            if (!uName || !uPass) {
                document.getElementById('errorDiv').classList.remove('hidden');
                document.getElementById('errorMessage').innerHTML = 'Username or Password is empty';
                return;
            } else if (uName.length < 4 || uPass.length < 4) {
                document.getElementById('errorDiv').classList.remove('hidden');
                document.getElementById('errorMessage').innerHTML = 'Username or Password must be at least 4 characters long';
                return;
            } else {
                // set hidden token and store growId
                const hiddenToken = document.getElementById('hiddenToken');
                if (hiddenToken) hiddenToken.value = '{}';
                loginForm.submit();
                localStorage.setItem('growId', document.getElementById('loginGrowId').value);
            }
        })
        document.getElementById('toggleLogPassword').addEventListener('click', function () {
            const LpasswordField = document.getElementById('loginPassword')
            const LpasswordFieldType = LpasswordField.getAttribute('type');
            if (LpasswordFieldType === 'password') {
                LpasswordField.setAttribute('type', 'text');
                this.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                LpasswordField.setAttribute('type', 'password');
                this.innerHTML = '<i class="fas fa-eye"></i>';
            }
        });

        // toggle between login and register forms
        const showLoginBtn = document.getElementById('showLogin');
        const showRegisterBtn = document.getElementById('showRegister');
        const loginFormEl = document.getElementById('loginForm');
        const registerFormEl = document.getElementById('registerForm');
        if (showLoginBtn && showRegisterBtn && loginFormEl && registerFormEl) {
            showRegisterBtn.addEventListener('click', function (e) {
                e.preventDefault();
                loginFormEl.classList.add('hidden');
                registerFormEl.classList.remove('hidden');
            });
            showLoginBtn.addEventListener('click', function (e) {
                e.preventDefault();
                registerFormEl.classList.add('hidden');
                loginFormEl.classList.remove('hidden');
            });
        }

        // register submission handler
        const registerBtn = document.getElementById('registerButton');
        if (registerBtn) {
            registerBtn.addEventListener('click', function (event) {
                event.preventDefault();
                const rGrow = document.getElementById('regGrowId').value;
                const rPass = document.getElementById('regPassword').value;
                const rEmail = document.getElementById('regEmail').value;
                const rServer = document.getElementById('regServer').value;

                if (!rGrow || !rPass || !rEmail) {
                    document.getElementById('errorDiv').classList.remove('hidden');
                    document.getElementById('errorMessage').innerHTML = 'All fields are required for registration';
                    return;
                }

                // set tokens for register form then submit
                const hiddenReg = document.getElementById('hiddenTokenReg');
                if (hiddenReg) hiddenReg.value = '{}';
                // copy growId to localStorage
                localStorage.setItem('growId', rGrow);
                // if server name provided, set it on hidden inputs of both forms
                if (rServer) {
                    // add a ServerName input to login form if missing
                    const loginServer = document.getElementById('loginServerName');
                    if (loginServer) loginServer.value = rServer;
                    const regServerInput = document.getElementById('regServer');
                    if (regServerInput) regServerInput.value = rServer;
                }

                // submit register form
                registerFormEl.submit();
            });
        }
    </script>
</body>

</html>
